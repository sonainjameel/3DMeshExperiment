<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ICIP Mesh Perception Study</title>
  <style>
    *{box-sizing:border-box;}
    body{margin:0;font-family:Arial;background:#111;color:white;}
    body.hide-cursor{cursor:none;}
    #welcome{display:flex;height:100vh;align-items:center;justify-content:center;flex-direction:column;}
    #experiment{display:none;height:100vh;flex-direction:row;}
    iframe{width:60%;height:100%;border:none;}
    .form-section{width:40%;padding:20px;background:#222;overflow-y:auto;}
    .question{margin-bottom:25px;}
    .scale{display:flex;justify-content:space-between;margin-top:10px;}
    .scale label{flex:1;text-align:center;padding:8px 0;}
    input[type=radio]{transform:scale(1.4);}
    textarea{width:100%;height:80px;margin-top:10px;border-radius:5px;padding:6px;}
    button{padding:10px 20px;background:#444;color:white;border:none;border-radius:5px;}
    button:hover{background:#666;}
  </style>
</head>
<body>

<div id="welcome">
  <h1>ICIP Mesh Perception Study</h1>
  <p>Evaluate the STL models with dynamic lighting and shadows.</p>
  <button onclick="startExp()">Start</button>
</div>

<div id="experiment">
  <iframe id="sceneFrame"></iframe>

  <form id="surveyForm" class="form-section" onsubmit="submitForm(event)">
    <h2 id="counter" style="text-align:center;">Scene 1 / 10</h2>

    <div class="question">
      <label>Q1: How realistic does the lighting feel?</label>
      <div class="scale">
        <label><input type="radio" name="q1" value="1" required>1</label>
        <label><input type="radio" name="q1" value="2">2</label>
        <label><input type="radio" name="q1" value="3">3</label>
        <label><input type="radio" name="q1" value="4">4</label>
        <label><input type="radio" name="q1" value="5">5</label>
        <label><input type="radio" name="q1" value="6">6</label>
        <label><input type="radio" name="q1" value="7">7</label>
      </div>
    </div>

    <div class="question">
      <label>Q2: How realistic and consistent are the shadows?</label>
      <div class="scale">
        <label><input type="radio" name="q2" value="1" required>1</label>
        <label><input type="radio" name="q2" value="2">2</label>
        <label><input type="radio" name="q2" value="3">3</label>
        <label><input type="radio" name="q2" value="4">4</label>
        <label><input type="radio" name="q2" value="5">5</label>
        <label><input type="radio" name="q2" value="6">6</label>
        <label><input type="radio" name="q2" value="7">7</label>
      </div>
    </div>

    <div class="question">
      <label>Q3: How clear and well-defined is the geometry?</label>
      <div class="scale">
        <label><input type="radio" name="q3" value="1" required>1</label>
        <label><input type="radio" name="q3" value="2">2</label>
        <label><input type="radio" name="q3" value="3">3</label>
        <label><input type="radio" name="q3" value="4">4</label>
        <label><input type="radio" name="q3" value="5">5</label>
        <label><input type="radio" name="q3" value="6">6</label>
        <label><input type="radio" name="q3" value="7">7</label>
      </div>
    </div>

    <div class="question">
      <label>Q4: How recognizable and structurally correct is the object?</label>
      <div class="scale">
        <label><input type="radio" name="q4" value="1" required>1</label>
        <label><input type="radio" name="q4" value="2">2</label>
        <label><input type="radio" name="q4" value="3">3</label>
        <label><input type="radio" name="q4" value="4">4</label>
        <label><input type="radio" name="q4" value="5">5</label>
        <label><input type="radio" name="q4" value="6">6</label>
        <label><input type="radio" name="q4" value="7">7</label>
      </div>
    </div>

    <div class="question">
      <label>Q5 (optional): Any issues noticed?</label>
      <textarea name="q5"></textarea>
    </div>

    <div style="text-align:center;"><button>Submit & Next</button></div>
  </form>
</div>

<script>
  const scenes = [
    "scene01.html","scene02.html","scene03.html","scene04.html","scene05.html",
    "scene06.html","scene07.html","scene08.html","scene09.html","scene10.html"
  ];
  scenes.sort(()=>Math.random()-0.5);

  let current=0;
  const results=[];
  let startTime=0;

  function startExp(){
    document.body.classList.add("hide-cursor");
    document.documentElement.requestFullscreen?.();
    document.getElementById("welcome").style.display="none";
    document.getElementById("experiment").style.display="flex";
    loadScene();
  }

  function loadScene(){
    document.getElementById("sceneFrame").src=scenes[current];
    document.getElementById("surveyForm").reset();
    document.getElementById("counter").innerText=`Scene ${current+1} / ${scenes.length}`;
    startTime = performance.now();
  }

  async function submitForm(e){
    e.preventDefault();
    const form = new FormData(document.getElementById("surveyForm"));
    const iframe = document.getElementById("sceneFrame");
    
    // Get hidden metrics from scene
    let metrics = {};
    try {
      if(iframe.contentWindow.getSceneMetrics) {
        metrics = iframe.contentWindow.getSceneMetrics();
      }
    } catch(err){ console.warn("Could not get metrics", err); }

    const entry = {
      scene: scenes[current],
      q1: form.get("q1"), q2: form.get("q2"), q3: form.get("q3"),
      q4: form.get("q4"), q5: form.get("q5") || "",
      time: ((performance.now()-startTime)/1000).toFixed(2),
      metrics: metrics
    };
    results.push(entry);

    current++;
    if(current<scenes.length) loadScene();
    else finishStudy();
  }

  function finishStudy(){
    document.getElementById("experiment").innerHTML="<h1>Thank you!</h1><p>Study complete.</p>";

    // Build CSV: each metric column flattened
    const header = ["scene","q1_light","q2_shadow","q3_geometry","q4_recognition","q5_notes","time"];
    // add all unique metric keys
    const metricKeys = new Set();
    results.forEach(r=>{
      for(const k in r.metrics) for(const subk in r.metrics[k]) metricKeys.add(`${k}_${subk}`);
    });
    const metricCols = Array.from(metricKeys);
    const csvHeader = header.concat(metricCols).join(",") + "\n";

    const csvRows = results.map(r=>{
      const row = [r.scene,r.q1,r.q2,r.q3,r.q4,`"${r.q5.replace(/"/g,'""')}"`,r.time];
      metricCols.forEach(col=>{
        const [meshName, key] = col.split("_");
        row.push(r.metrics[meshName]?.[key] ?? "");
      });
      return row.join(",");
    });

    const csvContent = csvHeader + csvRows.join("\n");
    const blob = new Blob([csvContent],{type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "ICIP_full_results.csv";
    a.click();
  }
</script>

</body>
</html>
